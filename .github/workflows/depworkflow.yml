name: Azure Container Apps Deploy

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'src/api/**'
      - 'src/web/**'
      - '.github/workflows/depworkflow-fixed.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'src/api/**'
      - 'src/web/**'
  workflow_dispatch:
    
env:
  # Azure Container Registry details
  AZURE_CONTAINER_REGISTRY: cr3rbky3yz3zumq
  REGISTRY_URL: cr3rbky3yz3zumq.azurecr.io
  
  # Container App Environment
  CONTAINER_APPS_ENVIRONMENT: agent-ca-env
  RESOURCE_GROUP: rg-crtwriter
  
  API_IMAGE_NAME: agent-api3
  WEB_IMAGE_NAME: agent-web3

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Set up variables
        id: vars
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          SHORT_SHA=${GITHUB_SHA::8}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          # Set image tags
          API_IMAGE_TAG="${{ env.REGISTRY_URL }}/${{ env.API_IMAGE_NAME }}:${BUILD_NUMBER}"
          WEB_IMAGE_TAG="${{ env.REGISTRY_URL }}/${{ env.WEB_IMAGE_NAME }}:${BUILD_NUMBER}"
          
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "api_image_tag=${API_IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "web_image_tag=${WEB_IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "üè∑Ô∏è Image tags:"
          echo "API: ${API_IMAGE_TAG}"
          echo "Web: ${WEB_IMAGE_TAG}"

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AGENTAPI2_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AGENTAPI2_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AGENTAPI2_AZURE_SUBSCRIPTION_ID }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src/api
          file: ./src/api/Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.api_image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push Web Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src/web
          file: ./src/web/Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.web_image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy API to Azure Container Apps
        run: |
          # Check if the container app exists
          if az containerapp show --name ${{ env.API_IMAGE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "‚úÖ Updating existing API container app..."
            az containerapp update \
              --name ${{ env.API_IMAGE_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ steps.vars.outputs.api_image_tag }} \
              --registry-server ${{ env.REGISTRY_URL }} \
              --registry-identity system \
              --revision-suffix "r${{ steps.vars.outputs.build_number }}" \
              --set-env-vars \
                ENVIRONMENT=production \
                BUILD_NUMBER=${{ steps.vars.outputs.build_number }} \
                GIT_SHA=${{ steps.vars.outputs.short_sha }}
          else
            echo "üÜï Creating new API container app..."
            az containerapp create \
              --name ${{ env.API_IMAGE_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
              --image ${{ steps.vars.outputs.api_image_tag }} \
              --target-port 80 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 10 \
              --cpu 0.5 \
              --memory 1Gi \
              --revision-suffix "r${{ steps.vars.outputs.build_number }}" \
              --registry-server ${{ env.REGISTRY_URL }} \
              --registry-identity system \
              --env-vars \
                ENVIRONMENT=production \
                BUILD_NUMBER=${{ steps.vars.outputs.build_number }} \
                GIT_SHA=${{ steps.vars.outputs.short_sha }}
          fi

      - name: Deploy Web to Azure Container Apps
        run: |
          # Check if the container app exists
          if az containerapp show --name ${{ env.WEB_IMAGE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "‚úÖ Updating existing Web container app..."
            az containerapp update \
              --name ${{ env.WEB_IMAGE_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ steps.vars.outputs.web_image_tag }} \
              --revision-suffix "r${{ steps.vars.outputs.build_number }}" \
              --set-env-vars \
                ENVIRONMENT=production \
                BUILD_NUMBER=${{ steps.vars.outputs.build_number }} \
                GIT_SHA=${{ steps.vars.outputs.short_sha }}
          else
            echo "üÜï Creating new Web container app..."
            az containerapp create \
              --name ${{ env.WEB_IMAGE_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_APPS_ENVIRONMENT }} \
              --image ${{ steps.vars.outputs.web_image_tag }} \
              --target-port 80 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 5 \
              --cpu 0.25 \
              --memory 0.5Gi \
              --revision-suffix "r${{ steps.vars.outputs.build_number }}" \
              --registry-server ${{ env.REGISTRY_URL }} \
              --registry-identity system \
              --env-vars \
                ENVIRONMENT=production \
                BUILD_NUMBER=${{ steps.vars.outputs.build_number }} \
                GIT_SHA=${{ steps.vars.outputs.short_sha }}
          fi

    #   - name: Get deployment URLs and create summary
    #     id: deployment
    #     run: |
    #       # Wait for deployments to stabilize
    #       echo "‚è≥ Waiting for deployments to stabilize..."
    #       sleep 30
          
    #       # Get Container App URLs
    #       API_URL=$(az containerapp show \
    #         --name ${{ env.API_IMAGE_NAME }} \
    #         --resource-group ${{ env.RESOURCE_GROUP }} \
    #         --query "properties.configuration.ingress.fqdn" \
    #         --output tsv)
          
    #       WEB_URL=$(az containerapp show \
    #         --name ${{ env.WEB_IMAGE_NAME }} \
    #         --resource-group ${{ env.RESOURCE_GROUP }} \
    #         --query "properties.configuration.ingress.fqdn" \
    #         --output tsv)
          
    #       # Set outputs
    #       echo "api_url=https://${API_URL}" >> $GITHUB_OUTPUT
    #       echo "web_url=https://${WEB_URL}" >> $GITHUB_OUTPUT
          
    #       # Create deployment summary
    #       cat >> $GITHUB_STEP_SUMMARY << EOF
    #       ## üöÄ Azure Container Apps Deployment Summary
          
    #       ### ‚úÖ Successfully Deployed Applications
          
    #       | Application | URL | Image Tag |
    #       |-------------|-----|-----------|
    #       | **API** | [https://${API_URL}](https://${API_URL}) | \`${{ steps.vars.outputs.build_number }}\` |
    #       | **Web** | [https://${WEB_URL}](https://${WEB_URL}) | \`${{ steps.vars.outputs.build_number }}\` |
          
    #       ### üì¶ Container Images
    #       - **API Image**: \`${{ steps.vars.outputs.api_image_tag }}\`
    #       - **Web Image**: \`${{ steps.vars.outputs.web_image_tag }}\`
          
    #       ### üîß Build Information
    #       - **Build Number**: ${{ steps.vars.outputs.build_number }}
    #       - **Git SHA**: \`${{ steps.vars.outputs.short_sha }}\`
    #       - **Branch**: \`${{ steps.vars.outputs.branch_name }}\`
    #       - **Environment**: \`${{ env.CONTAINER_APPS_ENVIRONMENT }}\`
    #       - **Resource Group**: \`${{ env.RESOURCE_GROUP }}\`
    #       EOF

    #   - name: Perform health checks
    #     run: |
    #       echo "üîç Performing application health checks..."
          
    #       API_URL="${{ steps.deployment.outputs.api_url }}"
    #       WEB_URL="${{ steps.deployment.outputs.web_url }}"
          
    #       # API Health Check
    #       echo "Checking API health at: $API_URL"
    #       API_HEALTHY=false
          
    #       for attempt in {1..6}; do
    #         echo "üîÑ API health check attempt $attempt/6..."
            
    #         if curl -f -s --max-time 10 "$API_URL/health" &>/dev/null || \
    #            curl -f -s --max-time 10 "$API_URL/" &>/dev/null || \
    #            curl -f -s --max-time 10 "$API_URL/docs" &>/dev/null; then
    #           echo "‚úÖ API is healthy and responding"
    #           API_HEALTHY=true
    #           break
    #         else
    #           echo "‚è≥ API not ready, waiting 15 seconds..."
    #           sleep 15
    #         fi
    #       done
          
    #       # Web Health Check
    #       echo "Checking Web application health at: $WEB_URL"
    #       WEB_HEALTHY=false
          
    #       for attempt in {1..6}; do
    #         echo "üîÑ Web health check attempt $attempt/6..."
            
    #         if curl -f -s --max-time 10 "$WEB_URL" &>/dev/null; then
    #           echo "‚úÖ Web application is healthy and responding"
    #           WEB_HEALTHY=true
    #           break
    #         else
    #           echo "‚è≥ Web application not ready, waiting 15 seconds..."
    #           sleep 15
    #         fi
    #       done
          
    #       # Update summary with health check results
    #       cat >> $GITHUB_STEP_SUMMARY << EOF
          
    #       ### üè• Health Check Results
    #       - **API Health**: $([ "$API_HEALTHY" = true ] && echo "‚úÖ Healthy" || echo "‚ùå Unhealthy")
    #       - **Web Health**: $([ "$WEB_HEALTHY" = true ] && echo "‚úÖ Healthy" || echo "‚ùå Unhealthy")
          
    #       EOF
          
    #       echo "üéâ Deployment completed successfully!"

    #   - name: Azure logout
    #     if: always()
    #     run: |
    #       az logout || true
    #       echo "üîê Logged out from Azure CLI"